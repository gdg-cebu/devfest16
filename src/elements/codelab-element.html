<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-styles/shadow.html">
<link rel="import" href="../../bower_components/paper-styles/color.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">

<dom-module id="codelab-element">

  <template>

    <style>
      :host {
        display: block;
      }

      :host(:hover) paper-material {
        @apply(--shadow-elevation-4dp);
      }

      :host(:active) paper-material {
        @apply(--shadow-none);
      }

      paper-material {
        display: flex;
        align-items: center;
        box-sizing: border-box;
        height: 100%;
        padding: 16px;
        font-weight: 300;
        cursor: pointer;
        @apply(--shadow-transition);
      }

      paper-material.quiz {
        color: #fff;
        background-color: var(--paper-red-500);
      }

      paper-material.done {
        color: #fff;
        background-color: var(--paper-green-500);
      }

      paper-material.quiz iron-icon,
      paper-material.done iron-icon {
        color: #fff;
      }

      .codelab-category {
        flex-shrink: 0;
        width: 50px;
        height: 50px;
        margin-right: 16px;
        object-fit: contain;
        object-position: center center;
      }

      .codelab-title {
        margin: 0;
        flex-grow: 1;
      }

      .codelab-status {
        flex-shrink: 0;
        margin-left: 8px;
        color: var(--paper-green-500);
      }

      paper-material.quiz-ready .codelab-status {
        color: #fff;
      }
    </style>

    <paper-material class$="[[_getStatusClass(status)]]" elevation="1">
      <img class="codelab-category" src="[[categoryImage]]" alt="[[data.title]]">
      <p class="codelab-title">[[data.title]]</p>
      <template is="dom-if" if="[[status !== 1]]">
        <iron-icon class="codelab-status" icon="[[_getStatusIcon(status)]]"></iron-icon>
      </template>
      <template is="dom-if" if="[[status === 1 || status === 3]]">
        <p class="codelab-timer">[[timeRemainingString]]</p>
      </template>
    </paper-material>

  </template>

  <script>
    (function() {
      'use strict';

      Polymer({

        is: 'codelab-element',

        properties: {
          data: Object,

          user: Object,

          progress: Object,

          progressPath: String,

          durationString: {
            type: String,
            computed: '_computeDurationStringProperty(data)'
          },

          categoryImage: {
            type: String,
            computed: '_computeCategoryImageProperty(data)'
          },

          status: {
            type: Number,
            computed: '_computeStatusProperty(data, progress)',
            observer: '_statusPropertyChanged'
          },

          timeRemaining: {
            type: Number,
            notify: true
          },

          timeRemainingString: String,

          timeRemainingTimer: Number
        },

        ready: function() {
          this.addEventListener('click', function() {
            this.fire('open-codelab', this);
          }.bind(this));
        },

        _computeDurationStringProperty: function() {
          return this._formatTime(this.data.duration);
        },

        _computeCategoryImageProperty: function() {
          return '/images/technologies/' + this.data.category + '.png';
        },

        _computeStatusProperty: function() {
          if (!this.data || !this.progress) {
            return 0;
          }
          return this.progress[this.data.key] ? this.progress[this.data.key].status : 0;
        },

        _statusPropertyChanged: function() {
          var el = this;
          if (this._isCurrentStatus('codelab-active')) {
            var duration = this.data.duration;
            var startTime = this.progress[this.data.key].codelab_start_time;
            this.timeRemaining = getRemainingTime(duration, startTime);
            if (this.timeRemaining > 0) {
              this.timeRemainingString = this._formatTimeShort(this.timeRemaining);
              this.timeRemainingTimer = setInterval(function() {
                this.timeRemaining = getRemainingTime(duration, startTime);
                this.timeRemainingString = this._formatTimeShort(this.timeRemaining);
                if (this.timeRemaining <= 0) {
                  clearInterval(this.timeRemainingTimer);
                  this.timeRemaining = 0;
                  this.timeRemainingString = null;
                  this._setToQuizReady();
                }
              }.bind(this), 1000);
            } else {
              this._setToQuizReady();
            }
          } else if (this._isCurrentStatus('quiz-active')) {
            var duration = this.data.quiz_duration;
            var startTime = this.progress[this.data.key].quiz_start_time;
            this.timeRemaining = getRemainingTime(duration, startTime);
            if (this.timeRemaining > 0) {
              this.timeRemainingString = this._formatTimeShort(this.timeRemaining);
              this.timeRemainingTimer = setInterval(function() {
                this.timeRemaining = getRemainingTime(duration, startTime);
                this.timeRemainingString = this._formatTimeShort(this.timeRemaining);
                if (this.timeRemaining <= 0) {
                  clearInterval(this.timeRemainingTimer);
                  this.timeRemaining = 0;
                  this.timeRemainingString = null;
                  this._setToFinished();
                }
              }.bind(this), 1000);
            } else {
              this._setToFinished();
              this._submitAnswers();
            }
          }

          function getRemainingTime(duration, start) {
            return duration - (Math.round((new Date()).getTime() / 1000) - start);
          }
        },

        _isCurrentStatus: function(string) {
          var status = ['codelab-ready', 'codelab-active', 'quiz-ready', 'quiz-active', 'finished'];
          return status[this.status] === string;
        },

        _getStatusIcon: function() {
          if (!this.data || !this.progress) {
            return null;
          }
          var icon = ['code', '', 'info', '', 'done'];
          return icon[this.status] || '';
        },

        _getStatusClass: function() {
          var classes = [null, null, 'quiz', 'quiz', 'done'];
          return classes[this.status] || null;
        },

        _setToCodelabActive: function() {
          var time = Math.round((new Date()).getTime() / 1000);
          var ref = this.progressPath + '/' + this.data.key;
          firebase.database().ref(this.progressPath).update({
            _user: {
              name: this.user.displayName,
              avatar: this.user.photoURL
            }
          });
          return firebase.database().ref(ref).update({ status: 1, codelab_start_time: time }).then(function() {
            this.fire('codelab-active');
          }.bind(this));
        },

        _setToQuizReady: function() {
          var ref = this.progressPath + '/' + this.data.key;
          var time = Math.round((new Date()).getTime() / 1000);
          return firebase.database().ref(ref).update({ status: 2, codelab_end_time: time }).then(function() {
            this.fire('quiz-ready');
          }.bind(this));
        },

        _setToQuizActive: function() {
          var ref = this.progressPath + '/' + this.data.key;
          var time = Math.round((new Date()).getTime() / 1000);
          return firebase.database().ref(ref).update({ status: 3, quiz_start_time: time }).then(function() {
            this.fire('quiz-active');
          }.bind(this));
        },

        _setToFinished: function() {
          clearInterval(this.timeRemainingTimer);
          var ref = this.progressPath + '/' + this.data.key;
          var time = Math.round((new Date()).getTime() / 1000);
          return firebase.database().ref(ref).update({ status: 4, quiz_end_time: time }).then(function() {
            this.fire('finished');
          }.bind(this));
        },

        _getQuestions: function() {
          var participantQuizRefPath = 'codelabs/participants/' + this.user.uid + '/' + this.data.key + '/quiz';
          var codelabQuestionsRefPath = 'codelabs/questions/' + this.data.key;

          if (this.quizData) {
            this.fire('questions-ready', this.quizData);
            return null;
          }

          firebase.database().ref(participantQuizRefPath).once('value', function(quizData) {
            quizData = quizData.val();
            var promise = new Promise(function(resolve, reject) {
              if (quizData) {
                resolve(quizData);
              } else {
                firebase.database().ref(codelabQuestionsRefPath).once('value', function(questionsData) {
                  questionsData = questionsData.val();
                  var questions = questionsData.sort(function() {
                    return Math.random() - 0.5;
                  }).slice(0, 5).map(function(question) {
                    question.choices = question.choices.map(function(choice, i) {
                      return {
                        choice: choice,
                        correct: i === 0,
                        selected: false
                      };
                    }).sort(function() {
                      return Math.random() - 0.5;
                    });
                    return question;
                  });
                  firebase.database().ref(participantQuizRefPath).set(questions).then(function() {
                    resolve(questions);
                  });
                });
              }
            });
            promise.then(function(quizData) {
              this.quizData = quizData;
              this.fire('questions-ready', quizData);
            }.bind(this));
          }.bind(this));
        },

        _setScore: function(score) {
          var refPath = 'codelabs/participants/' + this.user.uid + '/' + this.data.key + '/score';
          firebase.database().ref(refPath).set(score);
        },

        _getScore: function() {
          return this.progress[this.data.key].score;
        },

        _formatTime: function(time) {
          var hours = Math.floor(time / 60 / 60);
          var minutes = Math.floor(time / 60) % 60;
          var seconds = time % 60;
          var duration = [];
          if (hours > 0) {
            duration.push(hours + (hours > 1 ? ' hours' : ' hour'));
          }
          if (minutes > 0) {
            duration.push(minutes + (minutes > 1 ? ' minutes' : ' minute'));
          }
          if (seconds > 0) {
            duration.push(seconds + (seconds > 1 ? ' seconds' : ' second'));
          }
          if (duration.length <= 2) {
            return duration.join(' and ');
          }
          return duration.slice(0, duration.length - 1).join(', ')
            + ' and ' + duration[duration.length - 1];
        },

        _formatTimeShort: function(time) {
          var hours = Math.floor(time / 60 / 60);
          var minutes = Math.floor(time / 60) % 60;
          var seconds = time % 60;
          var time = [pad(minutes), pad(seconds)];

          function pad(n) {
            return n < 10 ? '0' + n : n;
          }

          if (hours > 0) {
            time.unshift(pad(hours));
          }
          return time.join(':');
        },

        _submitAnswers: function() {
          var correctAnswers = this.quizData.reduce(function(acc, question) {
            var questionCorrectlyAnswered = question.choices.reduce(function(acc, choice) {
              return (choice.selected && choice.correct) || acc;
            }, false);
            return acc + (questionCorrectlyAnswered ? 1 : 0);
          }, 0);
          var score = correctAnswers * 10;

          clearInterval(this.timeRemainingTimer);
          this.timeRemainingString = null;
          var ref = this.progressPath + '/' + this.data.key;
          var time = Math.round((new Date()).getTime() / 1000);
          firebase.database().ref(ref).update({
            status: 4,
            quiz_end_time: time,
            score: score,
            quiz: this.quizData
          });

          var currentScore = this.progress.total_score || 0;
          this.progress.total_score = currentScore + score;
          firebase.database().ref(this.progressPath + '/total_score').set(this.progress.total_score);
          firebase.database().ref(this.progressPath).setPriority(-this.progress.total_score);

          return score;
        }

      });
    })();
  </script>

</dom-module>
